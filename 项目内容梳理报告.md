# mermaidEdit 项目内容梳理报告

## 1. 项目概述

mermaidEdit 是一个基于 Tailwind CSS + TypeScript 的在线 mermaid 图表编辑器，提供简洁美观的左右分屏界面，支持 AI 辅助生成、实时预览、在线分享和导出功能。该项目采用纯前端架构，无后端服务，所有逻辑在浏览器端执行。

## 2. 项目整体架构和技术栈

### 2.1 技术架构

- **前端框架**：原生 TypeScript（无框架依赖）
- **样式框架**：Tailwind CSS 3.x
- **图表渲染**：mermaid.js 最新版本
- **构建工具**：Vite
- **包管理**：npm
- **本地存储**：IndexedDB（通过 idb 库）

### 2.2 架构特点

- **纯前端架构**：无后端服务，所有逻辑在浏览器端执行
- **模块化设计**：清晰的模块边界和职责分离
- **事件驱动**：基于自定义事件实现模块间通信
- **渐进增强**：核心功能优先，逐步添加增强功能

### 2.3 架构分层

```
┌─────────────────────────────────────────────────────────────┐
│                        前端应用层                              │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │   UI 组件    │  │  状态管理    │  │  工具函数    │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
├─────────────────────────────────────────────────────────────┤
│                      业务逻辑层                               │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  图表管理    │  │  AI 服务    │  │  存储服务    │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
├─────────────────────────────────────────────────────────────┤
│                      数据访问层                               │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  nocodb API │  │  IndexedDB  │  │ localStorage │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
```

## 3. 核心功能模块及其实现状态

### 3.1 图表编辑功能

- **实现状态**：✅ 已完整实现
- **核心组件**：[`Editor`](src/components/Editor/Editor.ts:1)
- **功能特点**：
  - 支持语法高亮的代码编辑器
  - 实时预览（300ms 防抖）
  - 自动保存到本地
  - 支持快捷键操作
  - AI 提示输入框（支持动态高度调整）
  - 提交快捷键：Ctrl/Cmd + Enter

### 3.2 实时预览功能

- **实现状态**：✅ 已完整实现
- **核心组件**：[`Preview`](src/components/Preview/Preview.ts:1)
- **功能特点**：
  - 左右分屏布局（左侧 40% 编辑器，右侧 60% 预览）
  - 实时渲染图表
  - 支持图表缩放（鼠标滚轮 + 按钮控制）
  - 支持图表拖拽移动
  - 支持图表重置视图
  - 错误提示和异常处理

### 3.3 AI 辅助生成功能

- **实现状态**：✅ 已完整实现
- **核心服务**：[`AIService`](src/services/AIService.ts:1)
- **功能特点**：
  - 支持多种 AI 提供商（OpenAI、Anthropic、自定义）
  - 智能生成 mermaid 代码
  - 支持基于现有代码修改
  - 专门的图表标题生成功能
  - 完善的错误处理和降级方案
  - 智能解析多种 API 响应格式

### 3.4 数据持久化功能

- **实现状态**：✅ 已完整实现
- **核心服务**：[`StorageService`](src/services/StorageService.ts:1)
- **功能特点**：
  - 本地 IndexedDB 存储
  - NocoDB 云端存储集成
  - 自动字段检查和创建
  - 离线同步队列
  - 冲突解决机制
  - 数据规范化处理

### 3.5 图表列表管理功能

- **实现状态**：✅ 已完整实现
- **核心组件**：[`ChartList`](src/components/ChartList/ChartList.ts:1)
- **功能特点**：
  - 显示已保存的图表列表
  - 点击列表项可切换到对应图表
  - 支持删除图表操作
  - 显示图表创建/更新时间
  - 支持刷新列表
  - 空状态提示
  - 加载状态指示

### 3.6 分享功能

- **实现状态**：✅ 已完整实现
- **核心组件**：[`ShareModal`](src/components/ShareModal/ShareModal.ts:1)
- **功能特点**：
  - 生成只读分享链接
  - 格式：`https://[domain]/share/[chart-id]`
  - 支持复制链接按钮
  - 支持二维码分享
  - 分享页面为只读模式

### 3.7 导出功能

- **实现状态**：✅ 已完整实现
- **核心服务**：[`ExportService`](src/services/ExportService.ts:1)
- **功能特点**：
  - PNG 导出（无背景，透明背景）
  - SVG 导出（无背景，压缩优化）
  - 支持设置导出文件名（默认：chart-[timestamp]）
  - 导出选项通过右键菜单访问

## 4. 数据流和状态管理

### 4.1 状态管理架构

- **核心状态管理**：[`AppStore`](src/store/AppStore.ts:1)
- **状态结构**：

  ```typescript
  interface AppState {
    currentChart: ChartData | null;
    charts: ChartData[];
    isLoading: boolean;
    error: string | null;
  }
  ```

### 4.2 数据流向

```
用户输入 → Editor → AppStore → Preview
                   ↓
              StorageService → IndexedDB
                   ↓
              NocoDB API (可选)
```

### 4.3 状态更新机制

- **单向数据流**：UI → Action → Store → UI
- **不可变更新**：使用结构化克隆确保状态不可变
- **批量更新**：合并短时间内的多次更新
- **订阅机制**：组件通过订阅 store 变化自动更新

### 4.4 事件系统

- **自定义事件**：基于浏览器 CustomEvent 实现模块间通信
- **主要事件类型**：
  - `open-config`：打开配置弹窗
  - `share-chart`：分享图表
  - `export-png/svg/mermaid`：导出图表
  - `generate-with-ai`：AI 生成图表
  - `mermaid-update`：更新预览
  - `ai-generation-complete`：AI 生成完成

## 5. 存储策略和同步机制

### 5.1 存储层次结构

```
┌─────────────────┐
│   nocodb API    │ 云端主存储
├─────────────────┤
│   IndexedDB     │ 本地缓存
├─────────────────┤
│  localStorage   │ 配置存储
├─────────────────┤
│  SessionStorage │ 临时状态
└─────────────────┘
```

### 5.2 同步策略

- **实时同步**：每次修改后 1 秒内触发同步
- **冲突解决**：最后写入优先（基于 updated_at 时间戳）
- **离线处理**：网络恢复后自动同步离线期间的更改
- **同步队列**：离线操作加入队列，网络恢复后自动执行

### 5.3 数据一致性保证

- **版本控制**：基于时间戳的版本控制
- **冲突检测**：基于时间戳的冲突检测
- **内容校验**：内容哈希验证完整性
- **规范化处理**：统一日期格式和字段命名

## 6. UI/UX 设计和交互体验

### 6.1 界面设计

- **整体风格**：使用 Tailwind CSS 默认主题，简洁的白色背景设计
- **布局结构**：
  - 顶部导航栏：Logo、标题、配置和分享按钮
  - 左侧边栏：图表列表（可折叠）
  - 主内容区：左侧编辑器，右侧预览
- **响应式设计**：支持不同屏幕尺寸

### 6.2 交互设计

- **加载状态**：骨架屏加载、进度条显示、友好的错误提示
- **操作反馈**：按钮点击有视觉反馈、成功操作显示 toast 提示、错误操作显示错误提示
- **快捷键支持**：
  - Ctrl/Cmd + Enter：提交 AI 生成
  - Ctrl/Cmd + B：切换侧边栏
  - Ctrl/Cmd + 滚轮：缩放图表

### 6.3 用户体验优化

- **实时预览**：输入时实时更新图表预览
- **自动保存**：修改后自动保存到本地
- **智能提示**：AI 输入框动态高度调整
- **拖拽操作**：支持图表拖拽移动
- **缩放控制**：多种缩放方式（按钮、滚轮、重置）

## 7. AI 集成功能实现

### 7.1 AI 服务架构

- **核心服务**：[`AIService`](src/services/AIService.ts:1)
- **支持的 AI 提供商**：OpenAI、Anthropic、自定义
- **认证方式**：Bearer Token、API Key、自定义头

### 7.2 AI 功能特点

- **智能生成**：根据自然语言描述生成 mermaid 代码
- **代码修改**：基于现有代码进行修改和优化
- **标题生成**：自动生成有意义的图表标题
- **错误处理**：完善的错误处理和降级方案
- **多格式支持**：智能解析多种 API 响应格式

### 7.3 AI 提示词优化

- **系统提示词**：专业的 mermaid 图表生成专家
- **图表类型选择**：根据描述内容自动选择最合适的图表类型
- **语法准确性**：严格遵循 mermaid 官方语法规范
- **样式优化**：应用适当的样式、颜色和格式

## 8. 项目部署和配置方案

### 8.1 构建配置

- **构建工具**：Vite
- **环境变量**：区分开发、测试、生产环境
- **代码分割**：按路由和组件分割代码
- **构建命令**：
  - `npm run dev`：开发环境
  - `npm run build`：生产构建
  - `npm run preview`：预览构建结果

### 8.2 部署方案

- **静态部署**：支持部署到 Vercel、Netlify、GitHub Pages
- **CDN 加速**：静态资源使用 CDN
- **自定义域名**：支持自定义域名配置
- **环境变量**：
  - `VITE_DEFAULT_NOCODB_URL`：默认 NocoDB 地址
  - `VITE_DEFAULT_TABLE_NAME`：默认表名

### 8.3 用户配置

- **AI 配置**：提供商、API Key、Base URL、模型名称
- **NocoDB 配置**：API 地址、API Key、表名
- **配置存储**：所有配置保存在浏览器本地

## 9. 项目优势和待改进点

### 9.1 项目优势

1. **技术架构优势**
   - 纯前端架构，无需后端服务，部署简单
   - 模块化设计，代码结构清晰，易于维护
   - 事件驱动架构，模块间解耦，扩展性好
   - 使用 TypeScript，类型安全，开发体验好

2. **功能完整性**
   - 核心功能完整实现，满足基本使用需求
   - AI 集成功能强大，支持多种 AI 提供商
   - 数据持久化方案完善，支持本地和云端存储
   - 离线同步机制，网络恢复后自动同步

3. **用户体验**
   - 界面简洁美观，操作直观
   - 实时预览，即时反馈
   - 自动保存，数据安全
   - 多种交互方式，满足不同用户习惯

4. **文档和规范**
   - 项目文档完整，包括架构设计、产品需求、实现计划
   - 代码规范统一，命名清晰
   - 注释详细，易于理解

### 9.2 待改进点

1. **功能扩展**
   - 支持更多图表类型和样式
   - 添加图表模板库
   - 支持图表导入功能
   - 添加协作编辑功能

2. **性能优化**
   - 大数据量时的性能优化
   - 图表渲染性能优化
   - 内存使用优化
   - 加载速度优化

3. **用户体验**
   - 添加更多快捷键支持
   - 优化移动端体验
   - 添加撤销/重做功能
   - 改进错误提示和用户引导

4. **技术改进**
   - 添加单元测试和集成测试
   - 代码分割和懒加载
   - 添加 PWA 支持
   - 优化构建体积

## 10. 总结

mermaidEdit 是一个功能完整、架构清晰的在线 mermaid 图表编辑器。项目采用纯前端架构，使用 TypeScript 和 Tailwind CSS 构建，具有良好的模块化设计和事件驱动架构。核心功能包括图表编辑、实时预览、AI 辅助生成、数据持久化、图表列表管理、分享和导出功能，均已完整实现。

项目的主要优势在于技术架构清晰、功能完整、用户体验良好、文档规范。待改进点主要集中在功能扩展、性能优化、用户体验和技术改进等方面。

总体而言，mermaidEdit 是一个高质量的前端项目，具有很好的可维护性和扩展性，为用户提供了便捷的 mermaid 图表编辑体验。
