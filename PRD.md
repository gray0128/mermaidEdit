# mermaidEdit 产品需求文档

## 1. 产品概述

### 1.1 产品定位

一个简洁美观的在线 mermaid 图表编辑器，专注于提供高效、智能的图表创建体验。

### 1.2 目标用户

- 技术人员：需要快速创建技术文档中的图表
- 产品经理：需要制作流程图、时序图等
- 学生和教育工作者：需要制作教学图表

## 2. 功能需求

### 2.1 核心功能

#### 用户配置

- **配置界面**
  - 用户需配置**模型信息**和 **KV 存储信息**
  - 提供配置弹窗，模型信息包含以下字段：
    - 提供商选择（OpenAI/Anthropic/自定义）
    - Base URL（文本输入框，必填）
    - API Key（密码输入框，必填）
    - 模型名称（文本输入框，必填）
  - KV 存储信息字段请**自行补充**
  
- 配置信息统一保存在 IndexedDB 中

#### 2.1.1 图表编辑

- **代码编辑器**
  - 基础文本编辑功能，用户在此处输入符合 mermaid 格式要求的内容
  - 自动格式化内容

#### 实时预览

- **实时预览**
  - 实时渲染图表
  - 支持图表缩放（鼠标滚轮 + 按钮控制）
  - 支持图表拖拽移动
  - 支持图表重置视图

#### 2.1.2 AI 辅助生成（可选功能 - 后期实现）

**注意：此功能为增强功能，不影响核心编辑器的使用**

- **生成功能**
  - 提供自然语言输入框（支持动态高度调整）
  - 支持用户直接输入指令，如"画一个流程图"
  - 支持对当前编辑内容进行指令操作，如"添加一个节点"
  - 自动生成一个专业的 mermaid 图表 prompt
  - 显示生成进度和错误提示
  - 使用用户配置的模型信息

**实现优先级：低（在基础编辑器完成后考虑）**

#### 列表展示

- **图表列表**
  - 以列表展示用户已保存的图表
  - 列表中需展示以下内容：
    - 图表名称
    - 创建时间
    - 更新时间
    - 是否已同步到云端
  - 对于当前选中的应有标识
  - 点击后加载对应的图表

#### 2.1.3 数据持久化

- **本地存储**
  - 使用 IndexedDB 作为主要存储方案
  - 自动保存编辑内容到本地

- **云端同步（可选）**
  - 手动同步到 Cloudflare KV
  - 明确的同步状态指示
  - 冲突检测和用户选择解决方案
  - 网络失败时的友好提示

#### 2.1.4 导出功能

- **导出选项**
  - PNG 导出（无背景，透明背景）
  - SVG 导出（无背景，压缩优化）
  - 支持设置导出文件名（默认：chart-[timestamp]）

### 2.2 用户体验

#### 2.2.1 界面设计

- **整体风格**
  - 有品味的界面设计

- **布局结构**

- 左侧：图表列表区域
- 中间：代码编辑区域
- 右侧：实时预览区域

**注意**：AI 辅助功能通过弹窗或临时替换编辑器模式实现，避免布局复杂化

#### 2.2.2 交互设计

- **加载状态**
  - 骨架屏加载
  - 进度条显示
  - 友好的错误提示

- **操作反馈**
  - 按钮点击有视觉反馈
  - 成功操作显示 toast 提示
  - 错误操作显示错误提示

## 3. 技术规范

### 3.1 技术栈

- **前端框架**：原生 TypeScript（无框架依赖）
- **样式框架**：Tailwind CSS
- **图表渲染**：mermaid.js 最新版本
- **本地存储**：IndexedDB（通过 idb 库）
- **云端存储**：cloudflare KV

### 3.2 浏览器兼容性

- Chrome  100 +

### 3.4 部署要求

- 支持使用静态资源服务器部署

## 4. 数据结构设计

### 4.1 KV 存储结构要求

至少应包含以下信息，可自行按需求补充：

- 图表 id，使用 uuid
- 图表名称
- 内容，记录编辑器中的 mermaid 内容
- 创建时间
- 更新时间

### 4.2 统一存储结构（IndexedDB）

**存储键值设计：**

- `config` -> UserConfig（用户配置）
- `chart:{uuid}` -> ChartData（图表数据）

**ChartData 结构：**

- 图表 id，使用 uuid
- 图表名称
- 内容，记录编辑器中的 mermaid 内容
- 创建时间
- 更新时间
- 同步状态（本地修改/已同步/同步失败）

## 5. 错误处理策略

### 5.1 核心原则

- **优雅降级**：功能失败时不影响核心编辑体验
- **明确反馈**：用户始终知道发生了什么
- **数据安全**：永不丢失用户数据

### 5.2 具体策略

**存储错误：**

- IndexedDB 失败时显示警告，但允许继续编辑
- 定期尝试重新保存失败的数据
- 提供手动导出功能作为备份

**渲染错误：**

- Mermaid 语法错误时显示具体错误位置
- 保持编辑器可用，不阻断用户输入
- 提供语法检查和自动修复建议

**网络错误：**

- 同步失败时明确显示离线状态
- 缓存失败的同步操作，网络恢复后重试
- AI 功能不可用时提供明确提示

**数据冲突：**

- 检测到冲突时暂停自动同步
- 提供并排比较界面让用户选择
- 支持手动合并冲突内容
